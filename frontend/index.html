<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
        <title>Library System</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
         <!-- Favicon -->
         <link rel="shortcut icon" type="image/x-icon" href="../../static/favicon.png">


         <style>
            body {
                margin: 0; /* Remove default margin */
                padding: 0; /* Remove default padding */
            }
    
            /* Add padding to the sections */
            .content-section {
                padding: 20px;
            }
    
            /* Optionally, add margin to create space between sections */
            .content-section + .content-section {
                margin-top: 20px;
            }
        </style>

         
    </head>
<body>

    <!-- Navigation Bar -->
<nav class="navbar navbar-expand-lg bg-body-tertiary">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">Library System Management</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="#" onclick="showSection('register-section')">Register</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="showSection('login-section')">Login</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="showSection('books-section')">Books</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="showSection('customers-section')">Customers</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="showSection('loans-section')">Loans</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="showSection('search-section')">search</a>
                </li>
            </ul>
        </div>
    </div>
</nav>
    
<section class="card content-section" id="books-section">
        <div class="container">
        <!-- Add the following lines for image handling -->
        <!-- <img src="../static/book.jpg" width="80" height="90"> -->
              
            <h2>Books</h2>
            <table class="table" id="booksTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Author</th>
                        <th>Year Published</th>
                        <th>Book Type</th>
                        <th>Delete</th>
                        <th>Update</th>
                        <th>Image</th>
                    </tr>
                </thead>
                <!-- Inside the <tbody> section -->
<tbody>
   
        <tr>
            <td>{{ book.id }}</td>
            <td>{{ book.name }}</td>
            <td>{{ book.author }}</td>
            <td>{{ book.year_published }}</td>
            <td>{{ book.book_type }}</td>
            <td>Delete button</td> <!-- Add your delete button here -->
            <td>Update button</td> <!-- Add your update button here -->

          <!-- <td>
                {% if book.image_url %}
                    <img src="{{ book.image_url }}" width="80" height="90">
                {% else %}
                    <img src="{{ book.image_url }}" width="80" height="90">
                {% endif %}
            </td> -->
        </tr>
    
</tbody>
                 <!-- book forms-->
            </table>
        
            <h2>Add New Book</h2>
            <form id="addBookForm" onsubmit="event.preventDefault(); addBook();">
                <div class="form-group">
                    <label for="bookName">Name:</label>
                    <input type="text" class="form-control" id="bookName" required>
                </div>
        
                <div class="form-group">
                    <label for="author">Author:</label>
                    <input type="text" class="form-control" id="author" required>
                </div>
        
                <div class="form-group">
                    <label for="yearPublished">Year Published:</label>
                    <input type="number" class="form-control" id="yearPublished" required>
                </div>
        
                <div class="mb-3">
                    <label for="book_type" class="form-label">Loan Time</label>
                    <select class="form-select" id="book_type" name="book_type" required>
                        <option value="1">10 days</option>
                        <option value="2">5 days</option>
                        <option value="3">2 days</option>
                    </select>
                </div>          

                <button type="submit" class="btn btn-primary">Add Book</button>
            </form>
        </div>
    </section>
        
    <!-- customers dorm -->
    <section class="card content-section" id="customers-section">
    <h2>Customers</h2>
    <table class="table" id="customersTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>City</th>
                <th>Age</th>
                <th>Delete</th>
                <th>Update</th>
            </tr>
        </thead>
        <tbody>
            
        </tbody>
    </table>

    <h2>Add New Customer</h2>
    <form id="addCustomerForm" onsubmit="event.preventDefault(); addCustomer();">
        <div class="form-group">
            <label for="customerName">Name:</label>
            <input type="text" class="form-control" id="customerName" required>
        </div>

        <div class="form-group">
            <label for="city">City:</label>
            <input type="text" class="form-control" id="city" required>
        </div>

        <div class="form-group">
            <label for="age">Age:</label>
            <input type="number" class="form-control" id="age" required>
        </div>

        <button type="submit" class="btn btn-primary">Add Customer</button>
    </form>
</div>
</section>

<!-- loans form -->
<section class="card content-section" id="loans-section">
    <h2>Loans</h2>
    <table class="table" id="loansTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Customer ID</th>
                <th>Book ID</th>
                <th>Loan Date</th>
                <th>Return Date</th>
                <th>Delete</th>
                <th>Update</th>
                <th></th>
                <th>loan is late</th>
            </tr>
        </thead>
        <tbody>
            
        </tbody>
    </table>

    <!-- Loan data will be displayed here -->
</tbody>
</table>

<h2>Add New Loan</h2>
<form id="addLoanForm" onsubmit="event.preventDefault(); addLoan();">
    <div class="form-group">
        <label for="custId">Customer ID:</label>
        <input type="number" class="form-control" id="custId" required>
    </div>

    <div class="form-group">
        <label for="bookId">Book ID:</label>
        <input type="number" class="form-control" id="bookId" required>
    </div>

    <div class="form-group">
        <label for="loanDate">Loan Date:</label>
        <input type="date" class="form-control" id="loanDate" required>
    </div>

    

    <button type="submit" class="btn btn-primary">Add Loan</button>
</form>

</div>

</section>

<!-- register form -->
<section id="register-section" class="content-section" >
    <title>Register</title>
    <!-- Include Axios library -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <h2>Register</h2>
    <form id="registerForm" onsubmit="event.preventDefault(); registerUser();">
        <div>
            <label for="username">Username:</label>
            <input type="text" class="form-control" id="registerUsername" required>
        </div>
        <div>
            <label for="password">Password:</label>
            <input type="password" class="form-control" id="registerPassword" required>
        </div>
        <div>
            <label for="role">Role:</label>
<select class="form-control" id="registerRole" required>
    <option value="" disabled selected>Select a role</option>
    <option value="manager">Manager</option>
    <option value="customer">Customer</option>
</select>

        </div>
        <button type="submit">Register</button>
    </form>
</section>

<!-- Login Form -->
<section class="card content-section" id="login-section" style="width: 50%">
    <div class="row">
        <div class="col-md-6"></div>
        <div class="col-md-6 d-flex align-items-center justify-content-center">
            <!-- Login Card -->
            <div class="card bg-burgundy">
                <div class="card-body">
                    <h5 class="card-title">Login</h5>
                    <form id="loginForm" onsubmit="event.preventDefault(); loginUser();">
                        <div class="mb-3">
                            <label for="loginUsername" class="form-label">Username</label>
                            <input type="text" class="form-control" id="loginUsername" required>
                        </div>
                        <div class="mb-3">
                            <label for="loginPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="loginPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Login</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<button id="logoutButton" class="btn btn-danger d-none" onclick="logout()">Logout</button>
</section>

<!-- search form-->
<section class="card content-section" id="search-section">
<form id="searchForm">
    <label for="searchTerm">Search Term:</label>
    <input type="text" id="searchTerm" name="searchTerm" required>
    <button type="button" onclick="searchBooks()">Search Books</button>
    <button type="button" onclick="searchCustomers()">Search Customers</button>
</form>

<!-- Display the search results -->
<div id="searchResults"></div>
</section>




    <script>

         
        // Fetch and display books on page load
        document.addEventListener('DOMContentLoaded', function () {
            fetchBooks();
        });

        // Function to fetch and display books using Axios
        function fetchBooks() {
            axios.get('/books')
                .then(response => {
                    const booksTable = document.getElementById('booksTable').getElementsByTagName('tbody')[0];
                    booksTable.innerHTML = '';

                    response.data.forEach(book => {
                        const row = booksTable.insertRow(-1);
                        row.insertCell(0).textContent = book.id;
                        row.insertCell(1).textContent = book.name;
                        row.insertCell(2).textContent = book.author;
                        row.insertCell(3).textContent = book.year_published;
                        row.insertCell(4).textContent = book.book_type;

                        // Add image cell
                const imageCell = row.insertCell(5);
                const imageElement = document.createElement('img');
                imageElement.width = 50;
                imageElement.height = 70;
                
                // Check if the book has an image
                if (book.image_url) {
                    imageElement.src = book.image_url;
                } else {
                    // Use default picture if there is no image
                    imageElement.src = '../static/book.jpg';
                }

                imageCell.appendChild(imageElement);

                        // Add delete button
                        const deleteButton = document.createElement('button');
                        deleteButton.textContent = 'Delete';
                        deleteButton.classList.add('btn', 'btn-danger', 'mr-2');
                        deleteButton.onclick = function () {
                            deleteBook(book.id);
                        };
                        row.insertCell(5).appendChild(deleteButton);

                        // Add update button
                        const updateButton = document.createElement('button');
                        updateButton.textContent = 'Update';
                        updateButton.classList.add('btn', 'btn-primary', 'mr-2');
                        updateButton.onclick = function () {
                            showUpdateForm(row);
                        };
                        row.insertCell(6).appendChild(updateButton);

                        // Add hidden update form
                        const updateForm = document.createElement('form');
                        updateForm.style.display = 'none';
                        updateForm.method = 'POST';  // Set the form method to POST
                        updateForm.action = `/books/upd/${book.id}`;  // Set the form action

                        const nameLabel = document.createElement('label');
                        nameLabel.textContent = 'Name:';
                        const nameInput = document.createElement('input');
                        nameInput.type = 'text';
                        nameInput.classList.add('form-control');
                        nameInput.name = 'name';  // Set the input name
                        nameInput.value = book.name;
                        nameInput.required = true;

                        const authorLabel = document.createElement('label');
                        authorLabel.textContent = 'Author:';
                        const authorInput = document.createElement('input');
                        authorInput.type = 'text';
                        authorInput.classList.add('form-control');
                        authorInput.name = 'author';
                        authorInput.value = book.author;
                        authorInput.required = true;

                        const yearLabel = document.createElement('label');
                        yearLabel.textContent = 'Year Published:';
                        const yearInput = document.createElement('input');
                        yearInput.type = 'number';
                        yearInput.classList.add('form-control');
                        yearInput.name = 'year_published';
                        yearInput.value = book.year_published;
                        yearInput.required = true;

                        const typeLabel = document.createElement('label');
                        typeLabel.textContent = 'Book Type:';
                        const typeInput = document.createElement('input');
                        typeInput.type = 'number';
                        typeInput.classList.add('form-control');
                        typeInput.name = 'book_type';
                        typeInput.value = book.book_type;
                        typeInput.required = true;

                        const submitButton = document.createElement('button');
                        submitButton.type = 'submit';
                        submitButton.classList.add('btn', 'btn-primary', 'mt-2');
                        submitButton.textContent = 'Update Book';

                        updateForm.appendChild(nameLabel);
                        updateForm.appendChild(nameInput);
                        updateForm.appendChild(authorLabel);
                        updateForm.appendChild(authorInput);
                        updateForm.appendChild(yearLabel);
                        updateForm.appendChild(yearInput);
                        updateForm.appendChild(typeLabel);
                        updateForm.appendChild(typeInput);
                        updateForm.appendChild(submitButton);

                        row.insertCell(7).appendChild(updateForm);
                    });
                })
                .catch(error => console.error('Error:', error));
        }

        // Function to add a new book using Axios
function addBook() {
    const bookName = document.getElementById('bookName').value;
    const author = document.getElementById('author').value;
    const yearPublished = parseInt(document.getElementById('yearPublished').value);
    const bookType = parseInt(document.getElementById('book_type').value);

    axios.post('/books', {
        name: bookName,
        author: author,
        year_published: yearPublished,
        book_type: bookType,
    }, {
        headers: {
            'Content-Type': 'application/json',
        },
    })
    .then(response => {
        if (response.status === 200) {
            document.getElementById('addBookForm').reset();
            fetchBooks();

            Toastify({
                text: "Book added successfully!",
                duration: 3000,
                gravity: "bottom", // Position of the toast
                position: "right", // Position of the toast
                backgroundColor: "green", // Background color of the toast
            }).showToast();
        }
    })
    .catch(error => {
        console.error('Error:', error);

        Toastify({
            text: "Error adding the book. Please try again.",
            duration: 3000,
            gravity: "bottom", // Position of the toast
            position: "right", // Position of the toast
            backgroundColor: "red", // Background color of the toast
        }).showToast();
    });
}


        // Function to delete a book using Axios
function deleteBook(bookId) {
    axios.delete(`/books/del/${bookId}`)
        .then(response => {
            if (response.status === 200) {
                fetchBooks();
                // Trigger Toastify notification for book deletion success
                Toastify({
                    text: "Book deleted successfully!",
                    duration: 3000,
                    gravity: "bottom",
                    position: "right",
                    backgroundColor: "green",
                }).showToast();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Trigger Toastify notification for book deletion error
            Toastify({
                text: "Error deleting book!",
                duration: 3000,
                gravity: "bottom",
                position: "right",
                backgroundColor: "red",
            }).showToast();
        });
}


        // Function to show/hide the update form
    function showUpdateForm(row) {
        const updateForm = row.cells[7].querySelector('form');
        updateForm.style.display = updateForm.style.display === 'none' ? 'block' : 'none';

        // Ensure the form is configured with the correct method
        updateForm.method = 'POST';  // Set the form method to POST

        // Add an event listener for form submission
        updateForm.addEventListener('submit', function (event) {
            event.preventDefault();  // Prevent the default form submission
            updateBook(row);
        });
    }

    // Function to update a book using Axios
    function updateBook(row) {
        const bookId = row.cells[0].textContent;
        const name = row.cells[7].querySelector('[name="name"]').value;
        const author = row.cells[7].querySelector('[name="author"]').value;
        const yearPublished = parseInt(row.cells[7].querySelector('[name="year_published"]').value);
        const bookType = parseInt(row.cells[7].querySelector('[name="book_type"]').value);

        axios.put(`/books/upd/${bookId}`, {
            name: name,
            author: author,
            year_published: yearPublished,
            book_type: bookType,
        }, {
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(response => {
            if (response.status === 200) {
                // Optionally, hide the form or handle success
                row.cells[7].querySelector('form').style.display = 'none';
                // Refresh the book list
                fetchBooks();
               // Show success Toastify notification
            Toastify({
                text: "Book updated successfully",
                duration: 3000, // 3 seconds
                close: true,
                gravity: "bottom", // bottom or top
                position: "center", // center, left, or right
                backgroundColor: "green",
            }).showToast();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // Show error Toastify notification
        Toastify({
            text: "Error updating book",
            duration: 3000, // 3 seconds
            close: true,
            gravity: "bottom", // bottom or top
            position: "center", // center, left, or right
            backgroundColor: "red",
        }).showToast();
    });
        }
        // Fetch and display customers on page load
document.addEventListener('DOMContentLoaded', function () {
    fetchCustomers();
});

// Function to fetch and display customers using Axios
function fetchCustomers() {
    axios.get('/customers')
        .then(response => {
            const customersTable = document.getElementById('customersTable').getElementsByTagName('tbody')[0];
            customersTable.innerHTML = '';

            response.data.forEach(customer => {
                const row = customersTable.insertRow(-1);
                row.insertCell(0).textContent = customer.id;
                row.insertCell(1).textContent = customer.name;
                row.insertCell(2).textContent = customer.city;
                row.insertCell(3).textContent = customer.age;

                // Add delete button
                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.classList.add('btn', 'btn-danger', 'mr-2');
                deleteButton.onclick = function () {
                    deleteCustomer(customer.id);
                };
                row.insertCell(4).appendChild(deleteButton);

                // Add update button
                const updateButton = document.createElement('button');
                updateButton.textContent = 'Update';
                updateButton.classList.add('btn', 'btn-primary', 'mr-2');
                updateButton.onclick = function () {
                    showUpdateFormCustomer(row);
                };
                row.insertCell(5).appendChild(updateButton);

                // Add hidden update form
                const updateForm = document.createElement('form');
                updateForm.style.display = 'none';
                updateForm.method = 'POST';  // Set the form method to POST
                updateForm.action = `/customers/upd/${customer.id}`;  // Set the form action

                const nameLabel = document.createElement('label');
                nameLabel.textContent = 'Name:';
                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.classList.add('form-control');
                nameInput.name = 'name';  // Set the input name
                nameInput.value = customer.name;
                nameInput.required = true;

                const cityLabel = document.createElement('label');
                cityLabel.textContent = 'City:';
                const cityInput = document.createElement('input');
                cityInput.type = 'text';
                cityInput.classList.add('form-control');
                cityInput.name = 'city';
                cityInput.value = customer.city;
                cityInput.required = true;

                const ageLabel = document.createElement('label');
                ageLabel.textContent = 'Age:';
                const ageInput = document.createElement('input');
                ageInput.type = 'number';
                ageInput.classList.add('form-control');
                ageInput.name = 'age';
                ageInput.value = customer.age;
                ageInput.required = true;

                const submitButton = document.createElement('button');
                submitButton.type = 'submit';
                submitButton.classList.add('btn', 'btn-primary', 'mt-2');
                submitButton.textContent = 'Update Customer';

                updateForm.appendChild(nameLabel);
                updateForm.appendChild(nameInput);
                updateForm.appendChild(cityLabel);
                updateForm.appendChild(cityInput);
                updateForm.appendChild(ageLabel);
                updateForm.appendChild(ageInput);
                updateForm.appendChild(submitButton);

                row.insertCell(6).appendChild(updateForm);
            });
        })
        .catch(error => console.error('Error:', error));
}

// Function to add a new customer using Axios
function addCustomer() {
    const customerName = document.getElementById('customerName').value;
    const city = document.getElementById('city').value;
    const ageInput = document.getElementById('age');
    const age = parseInt(ageInput.value);

    // Validate age
    if (isNaN(age) || age < 1) {
        // Trigger Toastify notification for age error
        Toastify({
            text: "Please enter a valid age (greater than 0).",
            duration: 3000,
            gravity: "bottom",
            position: "right",
            backgroundColor: "red",
        }).showToast();
        return;  // Stop execution if age is invalid
    }

    axios.post('/customers/new', {
        name: customerName,
        city: city,
        age: age,
    }, {
        headers: {
            'Content-Type': 'application/json',
        },
    })
        .then(response => {
            if (response.status === 200) {
                document.getElementById('addCustomerForm').reset();
                fetchCustomers();
                
                // Trigger Toastify notification for customer added
                Toastify({
                    text: "Customer added successfully!",
                    duration: 3000,
                    gravity: "bottom",
                    position: "right",
                    backgroundColor: "green",
                }).showToast();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Trigger Toastify notification for error
            Toastify({
                text: "Error adding customer. Please try again.",
                duration: 3000,
                gravity: "bottom",
                position: "right",
                backgroundColor: "red",
            }).showToast();
        });
}


// Function to delete a customer using Axios
function deleteCustomer(customerId) {
    axios.delete(`/customers/del/${customerId}`)
        .then(response => {
            if (response.status === 200) {
                fetchCustomers();
                // Trigger Toastify notification for customer deletion success
                Toastify({
                    text: "Customer deleted successfully!",
                    duration: 3000,
                    gravity: "bottom",
                    position: "right",
                    backgroundColor: "green",
                }).showToast();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Trigger Toastify notification for customer deletion error
            Toastify({
                text: "Error deleting customer!",
                duration: 3000,
                gravity: "bottom",
                position: "right",
                backgroundColor: "red",
            }).showToast();
        });
}


// Function to show/hide the update form for customers
function showUpdateFormCustomer(row) {
    const updateForm = row.cells[6].querySelector('form');
    updateForm.style.display = updateForm.style.display === 'none' ? 'block' : 'none';

    // Ensure the form is configured with the correct method
    updateForm.method = 'POST';  // Set the form method to POST

    // Add an event listener for form submission
    updateForm.addEventListener('submit', function (event) {
        event.preventDefault();  // Prevent the default form submission
        updateCustomer(row);
    });
}

// Function to update a customer using Axios
function updateCustomer(row) {
    const customerId = row.cells[0].textContent;
    const name = row.cells[6].querySelector('[name="name"]').value;
    const city = row.cells[6].querySelector('[name="city"]').value;
    const ageInput = row.cells[6].querySelector('[name="age"]');
    const age = parseInt(ageInput.value);

    // Validate age
    if (isNaN(age) || age < 1) {
        // Show error Toastify notification for invalid age
        Toastify({
            text: "Please enter a valid age (greater than 0).",
            duration: 3000,
            gravity: "bottom",
            position: "right",
            backgroundColor: "red",
        }).showToast();
        return;  // Stop execution if age is invalid
    }

    axios.put(`/customers/upd/${customerId}`, {
        name: name,
        city: city,
        age: age,
    }, {
        headers: {
            'Content-Type': 'application/json',
        },
    })
        .then(response => {
            if (response.status === 200) {
                // Optionally, hide the form or handle success
                row.cells[6].querySelector('form').style.display = 'none';
                // Refresh the customer list
                fetchCustomers();

                // Show success Toastify notification
                Toastify({
                    text: "Customer updated successfully",
                    duration: 3000, // 3 seconds
                    gravity: "bottom", // bottom or top
                    position: "right", // center, left, or right
                    backgroundColor: "green",
                }).showToast();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Show error Toastify notification
            Toastify({
                text: "Error updating customer",
                duration: 3000, // 3 seconds
                gravity: "bottom", // bottom or top
                position: "right", // center, left, or right
                backgroundColor: "red",
            }).showToast();
        });
}

// Fetch and display loans on page load
document.addEventListener('DOMContentLoaded', function () {
    fetchLoans();
});

// Function to fetch and display loans using Axios
function fetchLoans() {
    axios.get('/loans')
        .then(response => {
            const loansTable = document.getElementById('loansTable').getElementsByTagName('tbody')[0];
            loansTable.innerHTML = '';

            response.data.forEach(loan => {
                const row = loansTable.insertRow(-1);
                row.insertCell(0).textContent = loan.id;
                row.insertCell(1).textContent = loan.cust_id;
                row.insertCell(2).textContent = loan.book_id;
                row.insertCell(3).textContent = loan.loan_date;
                row.insertCell(4).textContent = loan.return_date;

                // Add "Late" column
                const lateCell = row.insertCell(5);
                const isLate = loan.is_late ? 'Yes' : 'No';  // Assuming is_late is a property
                lateCell.textContent = isLate;
                
                // Add delete button
                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.classList.add('btn', 'btn-danger', 'mr-2');
                deleteButton.onclick = function () {
                    deleteLoan(loan.id);
                };
                row.insertCell(5).appendChild(deleteButton);

                // Add update button
                const updateButton = document.createElement('button');
                updateButton.textContent = 'Update';
                updateButton.classList.add('btn', 'btn-primary', 'mr-2');
                updateButton.onclick = function () {
                    showUpdateFormLoan(row);
                };
                row.insertCell(6).appendChild(updateButton);

                /// Add hidden update form
const updateForm = document.createElement('form');
updateForm.style.display = 'none';
updateForm.method = 'POST';  // Set the form method to POST
updateForm.action = `/loans/upd/${loan.id}`;  // Set the form action

const custIdLabel = document.createElement('label');
custIdLabel.textContent = 'Customer ID:';
const custIdInput = document.createElement('input');
custIdInput.type = 'number';
custIdInput.classList.add('form-control');
custIdInput.name = 'cust_id';  // Set the input name
custIdInput.value = loan.cust_id;
custIdInput.required = true;

const bookIdLabel = document.createElement('label');
bookIdLabel.textContent = 'Book ID:';
const bookIdInput = document.createElement('input');
bookIdInput.type = 'number';
bookIdInput.classList.add('form-control');
bookIdInput.name = 'book_id';
bookIdInput.value = loan.book_id;
bookIdInput.required = true;

const loanDateLabel = document.createElement('label');
loanDateLabel.textContent = 'Loan Date:';
const loanDateInput = document.createElement('input');
loanDateInput.type = 'date';
loanDateInput.classList.add('form-control');
loanDateInput.name = 'loan_date';
loanDateInput.value = loan.loan_date;
loanDateInput.required = true;

const submitButton = document.createElement('button');
submitButton.type = 'submit';
submitButton.classList.add('btn', 'btn-primary', 'mt-2');
submitButton.textContent = 'Update Loan';

updateForm.appendChild(custIdLabel);
updateForm.appendChild(custIdInput);
updateForm.appendChild(bookIdLabel);
updateForm.appendChild(bookIdInput);
updateForm.appendChild(loanDateLabel);
updateForm.appendChild(loanDateInput);
updateForm.appendChild(submitButton);

row.insertCell(7).appendChild(updateForm);
            });
        })
        .catch(error => console.error('Error:', error));
}

function addLoan() {
    const custId = parseInt(document.getElementById('custId').value);
    const bookId = parseInt(document.getElementById('bookId').value);
    const loanDate = new Date(document.getElementById('loanDate').value);

    // Fetch existing loans for the specified book ID
    axios.get(`/loans?book_id=${bookId}`)
        .then(existingLoansResponse => {
            const existingLoans = existingLoansResponse.data;

            // Check if there are existing loans for the book
            if (existingLoans && existingLoans.length > 0) {
                // Show error Toastify notification
                Toastify({
                    text: "A loan for this book already exists. Cannot add duplicate loans.",
                    duration: 3000,
                    gravity: "bottom",
                    position: "right",
                    backgroundColor: "red",
                }).showToast();
            } else {
                // Add new loan
                axios.post('/loans/new', {
                    cust_id: custId,
                    book_id: bookId,
                    loan_date: loanDate.toISOString().split('T')[0], // Convert to ISO format (YYYY-MM-DD)
                }, {
                    headers: {
                        'Content-Type': 'application/json',
                    },
                })
                    .then(response => {
                        if (response.status === 200) {
                            document.getElementById('addLoanForm').reset();
                            fetchLoans();

                            // Trigger Toastify notification for loan added
                            Toastify({
                                text: "Loan added successfully!",
                                duration: 3000,
                                gravity: "bottom",
                                position: "right",
                                backgroundColor: "green",
                            }).showToast();
                        }
                    })
                    .catch(error => {
                        console.error('Error adding loan:', error);

                        // Trigger Toastify notification for error
                        Toastify({
                            text: "Error adding loan. Please try again.",
                            duration: 3000,
                            gravity: "bottom",
                            position: "right",
                            backgroundColor: "red",
                        }).showToast();
                    });
            }
        })
        .catch(error => {
            console.error('Error fetching existing loans:', error);
        });
}


/// Function to delete a loan using Axios
function deleteLoan(loanId) {
    axios.delete(`/loans/del/${loanId}`)
        .then(response => {
            if (response.status === 200) {
                fetchLoans();
                // Trigger Toastify notification for loan deletion success
                Toastify({
                    text: "Loan deleted successfully!",
                    duration: 3000,
                    gravity: "bottom",
                    position: "right",
                    backgroundColor: "green",
                }).showToast();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Trigger Toastify notification for loan deletion error
            Toastify({
                text: "Error deleting loan!",
                duration: 3000,
                gravity: "bottom",
                position: "right",
                backgroundColor: "red",
            }).showToast();
        });
}


// Function to show/hide the update form for loans
function showUpdateFormLoan(row) {
    const updateForm = row.cells[7].querySelector('form');
    updateForm.style.display = updateForm.style.display === 'none' ? 'block' : 'none';

    // Ensure the form is configured with the correct method
    updateForm.method = 'POST';  // Set the form method to POST

    // Add an event listener for form submission
    updateForm.addEventListener('submit', function (event) {
        event.preventDefault();  // Prevent the default form submission
        updateLoan(row);
    });
}


function updateLoan(row) {
    const loanId = row.cells[0].textContent;
    const custId = parseInt(row.cells[7].querySelector('[name="cust_id"]').value);
    const bookId = parseInt(row.cells[7].querySelector('[name="book_id"]').value);
    const loanDate = row.cells[7].querySelector('[name="loan_date"]').value;

    // Ensure the loanId, custId, bookId, and loanDate are valid before making the request
    if (loanId && !isNaN(custId) && !isNaN(bookId) && loanDate) {
        axios.put(`/loans/upd/${loanId}`, {
            cust_id: custId,
            book_id: bookId,
            loan_date: loanDate,
        }, {
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(response => {
            if (response.status === 200) {
                // Optionally, hide the form or handle success
                row.cells[7].querySelector('form').style.display = 'none';
                // Refresh the loan list
                fetchLoans();
                // Show success Toastify notification
                Toastify({
                    text: "Loan updated successfully",
                    duration: 3000,
                    gravity: "bottom",
                    position: "right",
                    backgroundColor: "green",
                }).showToast();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Show error Toastify notification
            Toastify({
                text: "Error updating loan",
                duration: 3000,
                gravity: "bottom",
                position: "right",
                backgroundColor: "red",
            }).showToast();
        });
    } else {
        // Handle invalid data case, e.g., display an error message
        console.error('Invalid data for updating loan');
    }
}



    const login = async () => {                              //  Login logic here
        try {
            const loginUsername = document.getElementById("loginUsername");
            const loginPassword = document.getElementById("loginPassword");

            const response = await axios.post(`${MY_SERVER}/user/login`, {
                username: loginUsername.value,
                password: loginPassword.value
            })
            sessionStorage.setItem("access_token", response.data.access_token)


            Toastify({                                      // Display success message
                text: "Login successful!", duration: 3000, close: true,
                gravity: "top-right", position: "center", backgroundColor: "green", stopOnFocus: true,
            }).showToast();

        } catch (error) {

            Toastify({                                      // Display error message
                text: "Login failed. Please try again.", duration: 4000, close: true, gravity: "top",
                position: "left", backgroundColor: "red", stopOnFocus: true,
            }).showToast();
            console.error(error);
        }
    };
    // Register function with Toastify for error handling
function registerUser() {
    const usernameInput = document.getElementById('registerUsername');
    const passwordInput = document.getElementById('registerPassword');
    const roleSelect = document.getElementById('registerRole');

    if (usernameInput && passwordInput && roleSelect) {
        const username = usernameInput.value;
        const password = passwordInput.value;
        const role = roleSelect.value;

        axios.post('http://127.0.0.1:5000/user/register', { username, password, role })
            .then(response => {
                if (response.status === 201) {
                    Toastify({
                        text: "Registration successful.",
                        duration: 3000,
                        gravity: "bottom", // Position of the toast
                        position: "right", // Position of the toast
                        backgroundColor: "green", // Background color of the toast
                    }).showToast();
                } else {
                    Toastify({
                        text: "Registration failed.",
                        duration: 3000,
                        gravity: "bottom",
                        position: "right",
                        backgroundColor: "red",
                    }).showToast();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Toastify({
                    text: "An error occurred during registration.",
                    duration: 3000,
                    gravity: "bottom",
                    position: "right",
                    backgroundColor: "red",
                }).showToast();
            });
    } else {
        console.error('Error: One or more input elements not found.');
    }
}


    // Function to handle login
function loginUser() {
    const username = document.getElementById('loginUsername').value;
    const password = document.getElementById('loginPassword').value;

    axios.post('http://127.0.0.1:5000/user/login', { username, password })
        .then(response => {
            if (response.status === 200) {
                alert('Login successful.');
                // Show the logout button after successful login
                document.getElementById('logoutButton').classList.remove('d-none');
            } else {
                alert('Login failed. An unexpected error occurred.');
            }
        })
        .catch(error => {
            if (error.response && error.response.status === 401) {
                // Show Toastify message for 401 status (Unauthorized)
                Toastify({
                    text: "Login failed. Please check your username and password.",
                    duration: 3000,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "red",
                }).showToast();
            } else {
                console.error('Error:', error);
                alert('Login failed. An unexpected error occurred.');
            }
        });
}

// Function to handle logout
function logout() {
    // Perform logout logic, e.g., clearing user session, etc.
    // For simplicity, you can just show an alert for now.
    alert('Logout successful.');
    // Hide the logout button after logout
    document.getElementById('logoutButton').classList.add('d-none');
}

    // Function to search for books by name
    function searchBooks() {
        const searchTerm = document.getElementById('searchTerm').value;
        axios.post('/books/search', { search_term: searchTerm })
            .then(response => displaySearchResults(response.data))
            .catch(error => console.error('Error:', error));
    }

    function searchCustomers() {
        const searchTerm = document.getElementById('searchTerm').value;
        axios.post('/customers/search', { search_term: searchTerm })
            .then(response => displaySearchResults(response.data))
            .catch(error => console.error('Error:', error));
    }

    function displaySearchResults(results) {
        const searchResultsDiv = document.getElementById('searchResults');
        // Clear previous results
        searchResultsDiv.innerHTML = '';

        if (results.length === 0) {
            searchResultsDiv.innerHTML = 'No results found.';
            return;
        }

        // Display results
        results.forEach(result => {
            const resultDiv = document.createElement('div');
            resultDiv.textContent = JSON.stringify(result);
            searchResultsDiv.appendChild(resultDiv);
        });
    }

    
    </script>

    <script>
        const sectionLinks = document.querySelectorAll('.nav-link');
        const contentSections = document.querySelectorAll('.content-section');
    
        // Initial setup: Hide all sections except the register section
        contentSections.forEach(section => {
            section.style.display = 'none';
        });
        document.getElementById('register-section').style.display = 'block';
    
        sectionLinks.forEach(link => {
            link.addEventListener('click', function () {
                const targetSectionId = this.getAttribute('onclick').match(/'(.*?)'/)[1];
                showSection(targetSectionId);
            });
        });
    
        function showSection(sectionId) {
            // Hide all sections
            contentSections.forEach(section => {
                section.style.display = 'none';
            });
            // Show the selected section
            document.getElementById(sectionId).style.display = 'block';
        }
    </script>


    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <!-- Footer -->
    <footer class="footer mt-5 bg-burgundy text-yellow">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <p>&copy; 2024 books.All rights reserved.</p>
                </div>
                <div class="col-md-6 text-md-right">
                    <p>Email: contact@bestlibrarybooks.com</p>
                </div>
            </div>
        </div>
    </footer>

</body>
</html>